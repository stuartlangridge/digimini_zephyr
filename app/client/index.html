<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>digimini_zephyr sender</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 1.5rem auto; padding: 1rem; line-height: 1.5; }
    h1 { margin-top: 0; font-size: 1.6rem; }
    button { padding: 0.6em 1.2em; margin: 0.4em 0.8em 0.4em 0; font-size: 1rem; cursor: pointer; border: 1px solid #444; border-radius: 6px; background: #f8f9fa; }
    button:hover { background: #e9ecef; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    textarea { width: 100%; min-height: 120px; padding: 0.8em; font-family: inherit; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; resize: vertical; box-sizing: border-box; }
    #status { margin: 1em 0; padding: 0.6em 1em; border-radius: 6px; background: #f0f4f8; min-height: 1.2em; }
    #total { font-weight: bold; font-size: 1.3rem; color: #0066cc; }
    progress { width: 100%; height: 1.2rem; margin-top: 0.5em; accent-color: #0066cc; }
    section { margin: 1.5em 0; }
    .thumbnail {
      width: 80px;
      height: 160px;
      object-fit: cover;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
    }
    .thumbnail.selected {
      border-color: #0066cc;
    }
  </style>
</head>
<body>
<h1>digimini_zephyr sender</h1>
<nav>
  <button id="connectBtn">Connect to digimini</button>
  <button id="disconnectBtn" disabled>Disconnect</button>
</nav>
<p id="status">Status: Not connected</p>
<main>
  <section>
    <h1>Send text</h1>
    <label for="dataBox">Data to send:</label><br>
    <textarea id="dataBox" placeholder="Type or paste here..."></textarea><br>
    <button id="fill5kBtn">Fill with 5k random chars</button>
    <button id="fill50Btn">Fill with 50 random chars</button>
    <button id="sendTextBtn" disabled>Send text</button>
  </section>

  <section>
    <h1>Send image</h1>
    <label>Choose image:</label><br>
    <div id="image-list" style="display: flex; flex-wrap: wrap; gap: 12px; margin: 1em 0;">
      <!-- Predefined images will be inserted here -->
    </div>

    <label for="imageUpload" style="display: block; margin: 1em 0 0.5em;">Or upload your own:</label>
    <input type="file" id="imageUpload" accept="image/*">

    <div style="margin: 1.5em 0;">
      <img id="preview" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 6px; display: none;">
    </div>
    <button id="sendImageBtn" disabled>Send image (80×160)</button>
  </section>
</main>

<aside id="progressContainer" hidden>
  <label>Sending progress:</label><br>
  <progress id="progressBar" value="0" max="100"></progress>
  <span id="progressText">0%</span>
</aside>
<script src="btle.js"></script>
<script src="image.js"></script>
<script>
// definitions
const connectBtn = document.getElementById("connectBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
const status = document.getElementById("status");
const dataBox = document.getElementById("dataBox");
const fill5kBtn = document.getElementById("fill5kBtn");
const fill50Btn = document.getElementById("fill50Btn");
const sendTextBtn = document.getElementById("sendTextBtn");
const sendImageBtn = document.getElementById("sendImageBtn");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const btleManager = new BTLEManager({
  uuids: {
    service: "D191D191-F070-51DE-C0DE-B1EA550C1A7E".toLowerCase(),
    us2server_cmd: "D191D191-F070-FEED-1DEA-B1EA550C1A7E".toLowerCase(),
    us2server_data: "D191D191-F070-FEED-DA7A-B1EA550C1A7E".toLowerCase(),
    server2us: "D191D191-F070-ACCE-55E5-B1EA550C1A7E".toLowerCase(),
  }
});

// handlers
function setStatus(text) {
  status.textContent = text;
}
async function connectBtnClick(e) { btleManager.connect(); }
async function disconnectBtnClick(e) { btleManager.disconnect(); }
async function fill(length) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 .,;:!?()[]{} -_/\\+=*\"'";
  let result = "";
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  dataBox.value = result;
  setStatus("Textarea filled with 5000 random characters");
  checkSendBtn();
}
async function sendBtnClick(tosend) {
    progressBar.value = 0;
    progressContainer.hidden = false;
    const res = await btleManager.send(tosend);
    progressContainer.hidden = true;

    const kbSent = res.bytes_transferred / 1024;
    const seconds = res.elapsed_ms / 1000;
    const secPerKb = kbSent > 0 ? (seconds / kbSent).toFixed(3) : "—";
    const kbPerSec = seconds > 0 ? (kbSent / seconds).toFixed(2) : "—";

    const benchmarkResult = `Completed in ${seconds.toFixed(1)} s | ${kbSent.toFixed(2)} kB | ${secPerKb} s/kB | ${kbPerSec} kB/s`;
    setStatus(benchmarkResult);
    console.log("benchmark", benchmarkResult);
}
async function sendTextBtnClick(e) {
  const tosend = dataBox.value.trim();
  if (tosend.length > 0) {
    await sendBtnClick(tosend);
  }
}
async function sendImageBtnClick(e) {
  const tosend = selectedImageData;
  if (tosend) {
    await sendBtnClick(tosend);
  }
}
async function checkSendBtn() {
  // checks both buttons
  if (dataBox.value.trim().length > 0 && btleManager.connected) {
    sendTextBtn.disabled = false;
  } else {
    sendTextBtn.disabled = true;
  }
  if (selectedImageData !== null && btleManager.connected) {
    sendImageBtn.disabled = false;
  } else {
    sendImageBtn.disabled = true;
  }
}
async function dataEntered(e) {
  checkSendBtn();
}
async function connected(e) {
  connectBtn.disabled = true;
  disconnectBtn.disabled = false;
  checkSendBtn();
  dataBox.focus();
}
async function disconnected(e) {
  connectBtn.disabled = false;
  disconnectBtn.disabled = true;
  progressContainer.hidden = true; // shouldn't be needed, but...
  checkSendBtn();
}
async function updateProgress(e) {
  console.log("update progress", e)
  const percent = Math.round(e.detail.progress * 100);
  progressBar.value = percent;
  progressText.textContent = `${percent}% (${e.detail.elapsed_ms / 1000}s)`;
}
// handler hookup
document.addEventListener("btle-connect", connected);
document.addEventListener("btle-disconnect", disconnected);
document.addEventListener("btle-status", e => { setStatus(e.detail.text); });
document.addEventListener("btle-progress", updateProgress);
connectBtn.addEventListener("click", connectBtnClick);
disconnectBtn.addEventListener("click", disconnectBtnClick);
fill5kBtn.addEventListener("click", () => { fill(5000); });
fill50Btn.addEventListener("click", () => { fill(50); });
sendTextBtn.addEventListener("click", sendTextBtnClick);
sendImageBtn.addEventListener("click", sendImageBtnClick);
dataBox.addEventListener("input", dataEntered);
</script>
</body>
</html>